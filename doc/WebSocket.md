# WebSocket

WebSocket协议[RFC 6455](https://tools.ietf.org/html/rfc6455)提供了一种标准化的方式，通过单个TCP连接在客户端和服务器之间建立全双工，双向通信通道。 它是来自HTTP的一种不同的TCP协议，但被设计为通过HTTP工作，使用端口80和443并允许重新使用现有的防火墙规则。

很多开发语言都支持了WebSocket，比如Java、NodeJS、Go等等。主流常见的浏览器也对WebSocket进行了支持。

下图，浏览器的支持情况（图片来源：[caniuse](https://caniuse.com/#search=websocket)）

![](/Users/luomu32/Downloads/WX20180603-212426@2x.png)

WebSocket是一种异步的，基于事件驱动的消息体系结构。

WebSocket也是一种低级传输协议，它不像HTTP那样规定消息内容的任何语义。这意味着客户端和服务器需要协商对消息语义达成一致，否则无法路由或处理消息。WebSocket客户端和服务器端可以通过HTTP握手时，请求头“Sec-WebSocket-Protocol”来协商使用更高级的消息传递协议，比如STOMP。

在互联网环境中，往往存在着代理服务器。这往往会中断WebSocket连接。所以一般情况下，往往在防火墙内的内部应用之间使用WebSocket更适合。

## Ping和Pong

Ping和Pong属于WebSocket定义的控制帧，常常用于客户端与服务端保持心跳，防止长时间未活跃而被中断连接。

Ping和Pong最长允许发送125字节内容，如果超过长度将会抛出一个异常。

按照《Java WebSocket编程》书中说讲，当收到一个Ping消息时，应当返回内容一致的Pong消息。而收到Pong消息时，没有义务作出响应，所以Pong常用于单向的心跳。

## 异步发送

WebSocket除了支持同步发送外，还支持异步发送。对于有些发送大数据的场景下，更倾向于异步发送。同步发送时，会被阻塞，直到消息内容传输完成。异步发送时，会在编码和传输之前就返回。

异步发送还可以设置超时时间。

## 批量发送

WebSocket支持消息的批量发送。当需要发送的消息达到一个临界水平后，才会通过低层的连接传输出去。

批量发送也是按照顺序发送。

批量发送默认不开启。如果应用服务器支持，可以通过设置手动启用。另外还会提供一个方法，用于手动的将收集未发送的消息发送出去。

开启批量发送的主要目的是为了性能，尤其是那些短时间有大量消息需要发送的场景。但是性能改进依赖很多因素：

- 发送消息的大小
- 发送消息的频率
- 发送消息所处的网络
- 接受端的性能表现

所以，在使用这个特性之前，最好做一些测试来决定是否有必要。

### 对异步发送的影响

- 如果该异步发送的消息，还未达到批量发送的条件，不会导致通过底层连接发送出去，那么当消息到达批消息时，就认为该异步发送已经完成。
- 如果该异步发送的消息，导致这个批次的消息通过底层连接发送出去，那么只有当整个批次的消息都发送出去后，该异步发送算已经完成。

## 缓冲

WebSocket允许将消息拆分成多个小数据帧进行传输。WebSocket的底层实现的分片传输不一定能与API中的分片传输一一对应。比如有时候我们接受一整个消息，但是底层传输时，消息可能是一片一片传输的。应用服务器会将接受到的部分消息缓存起来，当接受到所有的消息之后，组装成一个完整的消息。

有时候会因为应用接受大消息，或有恶意的客户端等情况，我们需要控制缓冲区的大小。我们可以在Session上控制每个会话的缓冲区大小。当超过该大小时，会抛出一个错误，连接被关闭，CloseReason.CloseCode.TOO_BIG错误代码会被使用。

## 回执

WebSocket发送消息成功，并不表示消息被另一端正确的接受。消息并没有传输到另一端且没有错误发送的情况也是有可能发生的。如果需要确切的知道消息是否被另一端消费成功了，那么需要程序地控制，即另一端发送一个回执消息，表示接收者收到了消息的确认。

## 子协议和扩展

子协议和扩展的敲定发生在握手阶段。敲定子协议时，以客户端支持的子协议顺序去匹配服务端支持的。在敲定扩展时，扩展的顺序很重要。

###子协议

可以将一些特定于具体应用的消息格式或编排定义为一个字协议。

在进行握手时，客户端会向服务端发送一个或多个可选的子协议，也可以不发送。如果发送，服务端收到后，会选择一个支持的子协议返回到客户端。

在[IANA](www.iana.org)上有个[WebSocket子协议注册表](https://www.iana.org/assignments/websocket/websocket.xhtml)，表明一些标准的WebSocket子协议。

### 扩展

WebSocket允许在数据帧内插入任意数据，这些数据可以在中间服务器做路由，也可以描述或限定传输的数据。如果需要这种能力，就需要扩展WebSocket协议，这中方案称之为WebSocket扩展。

已有一些扩展，如deflate用于压缩；mux用于在一个物理TCP连接上使用多个WebSocket连接提升伸缩性。不同的应用服务器支持的扩展不同，`WebSocketContainer`类会由运行的应用服务器生成，该类提供一个方法用于获取该应用服务器所支持的扩展列表。

## 安全

类似于HTTPS，WebSocket也有连接加密方案，以wss作为URI前缀。

认证、授权等功能可以在握手阶段自定义处理。

## 负载均衡

WebSocket底层通过TCP连接通信。一台机器支持的TCP连接数是有限制的，所以为了支持大量的WebSocket的连接，我们需要负载均衡。

Nginx支持WebSocket的负载均衡，需要做一些额外的配置。